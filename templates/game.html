<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Norsk Skrivetrening</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-card" role="status" aria-live="polite" aria-busy="true">
      <div>
          <img
              src="{{ url_for('static', filename='troll.png') }}"
              class="troll-img"
              alt="Writing Troll"
              loading="eager"
              decoding="async"
          />
      </div>
      <div class="loading-title" id="loadingTitle">Analyserer grammatikken...</div>
      <div class="loading-subtitle" id="loadingSubtitle">
        Dette kan ta opptil 40 sekunder
      </div>
    </div>
  </div>
  <main class="game">
    <header class="game-header">
      <h1 class="game-title">Norsk Skrivetrening</h1>

      <div class="game-status">
        <div class="status-item">
          <div class="status-label">Nivå</div>
          <div class="status-value">{{ level }}</div>
        </div>

        <div class="status-item">
          <div class="status-label">Riktig på rad</div>
          <div class="status-value">{{ correct_streak }}</div>
        </div>

        <div class="status-item">
          <div class="status-label">Feil på rad</div>
          <div class="status-value">{{ incorrect_streak }}</div>
        </div>

        <div class="status-item">
          <div class="status-label">Forsøk på nivå</div>
          <div class="status-value">{{ turns_at_level }} / 5</div>
        </div>
      </div>
    </header>

    <section class="prompt">
      <div class="prompt-kicker">Oversett til norsk</div>
      <div class="prompt-sentence">
        {{ english_sentence }}
      </div>
    </section>

    <section class="answer">
      <form action="/game/submit" method="post" class="answer-form" id="answerForm">
        <!-- game/session tracking -->
        <input type="hidden" name="level" value="{{ level }}">
        <input type="hidden" name="sentence_id" value="{{ sentence_id }}">
        <input type="hidden" name="english_sentence" value="{{ english_sentence }}">

        <label class="answer-label" for="norwegian">
          Din oversettelse
        </label>

        <textarea
          id="norwegian"
          name="norwegian"
          rows="2"
          required
          placeholder="Skriv setningen på norsk…"
          autofocus
        ></textarea>

        <div class="answer-actions">
          <button type="submit" id="submitBtn">Sjekk</button>
          <a class="quiet-link" href="/">Avslutt</a>
        </div>
      </form>
    </section>
  </main>

  <script>
    (function () {
      const form = document.getElementById("answerForm");
      const overlay = document.getElementById("loadingOverlay");
      const btn = document.getElementById("submitBtn");
      const textarea = document.getElementById("norwegian");
      const progressFill = document.getElementById("progressFill");
      const stepsEl = document.getElementById("loadingSteps");

  
      const loadingTitle = document.getElementById("loadingTitle");
  
      if (!form || !overlay || !btn) return;
  
      const MIN_SPINNER_MS = 450;
  
      // ---- Staged loading copy (drop-in logic) ----
      const STAGES = [
        { title: "Analyserer grammatikken...", labelStep: 0, pct: 20 },
        { title: "Sjekker ordstilling og bøying...", labelStep: 1, pct: 45 },
        { title: "Sammenligner med gode eksempler...", labelStep: 2, pct: 70 },
        { title: "Forbereder tilbakemelding...", labelStep: 3, pct: 92 }
      ];

let stageTimer = null;

function setStepState(activeIndex) {
  if (!stepsEl) return;
  const nodes = stepsEl.querySelectorAll(".loading-step");
  nodes.forEach((node, idx) => {
    node.classList.toggle("is-active", idx === activeIndex);
    node.classList.toggle("is-complete", idx < activeIndex);
  });
}


function startLoadingStages() {
  if (!loadingTitle) return;

  let i = 0;

  loadingTitle.textContent = STAGES[i].title;
  setStepState(STAGES[i].labelStep);

  stageTimer = window.setInterval(() => {
    i += 1;

    if (i < STAGES.length) {
      loadingTitle.textContent = STAGES[i].title;
      setStepState(STAGES[i].labelStep);
    } else {
      stopLoadingStages();
    }
  }, 7500);
}


function stopLoadingStages() {
  if (stageTimer) {
    window.clearInterval(stageTimer);
    stageTimer = null;
  }
}

/* Call this right before you swap to the feedback HTML */
function finishLoadingStages() {
  // Mark all complete and fill to 100% for a satisfying finish
  setStepState(4);
}
      // --------------------------------------------
  
      // Enter = submit, Shift+Enter = newline
      if (textarea) {
        textarea.addEventListener("keydown", function (e) {
          // Avoid interfering with IME composition (important for some keyboards)
          if (e.isComposing) return;
  
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
  
            // Avoid double-submits while loading
            if (btn.disabled) return;
  
            // Trigger the existing submit handler (which shows overlay + fetch)
            form.requestSubmit ? form.requestSubmit(btn) : form.submit();
          }
        });
      }
  
      form.addEventListener("submit", async function (e) {
  e.preventDefault();

  const start = performance.now();
  const OVERLAY_DELAY_MS = 160; // show only if it’s not instant
  let overlayShown = false;

  // Schedule overlay to appear a bit later (prevents flashing on fast responses)
  const overlayTimer = window.setTimeout(() => {
    overlayShown = true;

    overlay.classList.add("is-visible");
    overlay.setAttribute("aria-hidden", "false");

    startLoadingStages();
  }, OVERLAY_DELAY_MS);

  // Disable inputs immediately to avoid double-submits
  btn.disabled = true;
  btn.textContent = "Sjekker…";
  if (textarea) textarea.readOnly = true;

  try {
    const formData = new FormData(form);

    const resp = await fetch(form.action, {
      method: "POST",
      body: formData,
      credentials: "same-origin",
      headers: { "X-Requested-With": "fetch" }
    });

    const html = await resp.text();

    // If request finished quickly, prevent overlay from showing
    window.clearTimeout(overlayTimer);

    // If overlay did show, enforce minimum visible time
    if (overlayShown) {
      const elapsed = performance.now() - start;
      const wait = Math.max(0, MIN_SPINNER_MS - elapsed);
      if (wait > 0) await new Promise(r => setTimeout(r, wait));

      stopLoadingStages();
      finishLoadingStages();
    }

    // Replace the page with the server response (feedback.html)
    document.open();
    document.write(html);
    document.close();
  } catch (err) {
    // Ensure overlay won't pop in after an error
    window.clearTimeout(overlayTimer);

    if (overlayShown) {
      stopLoadingStages();
      overlay.classList.remove("is-visible");
      overlay.setAttribute("aria-hidden", "true");
    }

    btn.disabled = false;
    btn.textContent = "Sjekk";
    if (textarea) textarea.readOnly = false;

    alert("Noe gikk galt. Prøv igjen.");
  }
});

  
      // Reset if BFCache returns user to this page
      window.addEventListener("pageshow", function () {
        stopLoadingStages();
        overlay.classList.remove("is-visible");
        overlay.setAttribute("aria-hidden", "true");
        btn.disabled = false;
        btn.textContent = "Sjekk";
        setStepState(0);
        if (textarea) textarea.readOnly = false;
      });
    })();
  </script>
  

</body>
</html>
