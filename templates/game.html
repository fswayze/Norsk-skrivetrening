<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Norsk Skrivetrening</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- Loading overlay (hidden by default) -->
  <div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-card" role="status" aria-live="polite" aria-busy="true">
      <div class="loading-spinner" aria-hidden="true"></div>
      <div class="loading-title">Sjekker svaret ditt…</div>
      <div class="loading-subtitle">Dette tar ofte 1–3 sekunder.</div>
    </div>
  </div>

  <main class="game">
    <header class="game-header">
      <h1 class="game-title">Norsk Skrivetrening</h1>

      <div class="game-status">
        <div class="status-item">
          <div class="status-label">Nivå</div>
          <div class="status-value">{{ level }}</div>
        </div>

        <div class="status-item">
          <div class="status-label">Riktig på rad</div>
          <div class="status-value">{{ correct_streak }}</div>
        </div>

        <div class="status-item">
          <div class="status-label">Feil på rad</div>
          <div class="status-value">{{ incorrect_streak }}</div>
        </div>

        <div class="status-item">
          <div class="status-label">Forsøk på nivå</div>
          <div class="status-value">{{ turns_at_level }} / 5</div>
        </div>
      </div>
    </header>

    <section class="prompt">
      <div class="prompt-kicker">Oversett til norsk</div>
      <div class="prompt-sentence">
        {{ english_sentence }}
      </div>
    </section>
    <section class="answer">
      <form action="/game/submit" method="post" class="answer-form" id="answerForm">
        <!-- game/session tracking -->
        <input type="hidden" name="level" value="{{ level }}">
        <input type="hidden" name="sentence_id" value="{{ sentence_id }}">
        <input type="hidden" name="english_sentence" value="{{ english_sentence }}">

        <label class="answer-label" for="norwegian">
          Din oversettelse
        </label>

        <textarea
          id="norwegian"
          name="norwegian"
          rows="6"
          required
          placeholder="Skriv setningen på norsk…"
          autofocus
        ></textarea>

        <div class="answer-actions">
          <button type="submit" id="submitBtn">Sjekk</button>
          <a class="quiet-link" href="/">Avslutt</a>
        </div>
      </form>
    </section>

    <footer class="game-footer">
      <p class="game-note">
        Tips: Sikt på naturlig norsk. Småfeil teller — dette er prøvemodus.
      </p>
    </footer>
  </main>

  <script>
    (function () {
      const form = document.getElementById("answerForm");
      const overlay = document.getElementById("loadingOverlay");
      const btn = document.getElementById("submitBtn");
      const textarea = document.getElementById("norwegian");
  
      if (!form || !overlay || !btn) return;
  
      const MIN_SPINNER_MS = 450; // tune 300–700
  
      form.addEventListener("submit", async function (e) {
        e.preventDefault();
  
        // Show overlay immediately
        const start = performance.now();
        overlay.classList.add("is-visible");
        overlay.setAttribute("aria-hidden", "false");
        btn.disabled = true;
        btn.textContent = "Sjekker…";
        if (textarea) textarea.readOnly = true;
  
        try {
          const formData = new FormData(form);
  
          const resp = await fetch(form.action, {
            method: "POST",
            body: formData,
            credentials: "same-origin",
            headers: {
              "X-Requested-With": "fetch"
            }
          });
  
          const html = await resp.text();
  
          // Enforce minimum visible time
          const elapsed = performance.now() - start;
          const wait = Math.max(0, MIN_SPINNER_MS - elapsed);
          if (wait > 0) await new Promise(r => setTimeout(r, wait));
  
          // Replace the page with the server response (feedback.html)
          document.open();
          document.write(html);
          document.close();
        } catch (err) {
          // If something goes wrong, reset UI so the user can retry
          overlay.classList.remove("is-visible");
          overlay.setAttribute("aria-hidden", "true");
          btn.disabled = false;
          btn.textContent = "Sjekk";
          if (textarea) textarea.readOnly = false;
  
          alert("Noe gikk galt. Prøv igjen.");
        }
      });
  
      // Reset if BFCache returns user to this page
      window.addEventListener("pageshow", function () {
        overlay.classList.remove("is-visible");
        overlay.setAttribute("aria-hidden", "true");
        btn.disabled = false;
        btn.textContent = "Sjekk";
        if (textarea) textarea.readOnly = false;
      });
    })();
  </script>
  
</body>
</html>
